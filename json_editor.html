<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON 配置编辑器 - VisionKit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@arco-design/web-vue@latest/dist/arco-vue.min.js"></script>
    <script src="https://unpkg.com/@arco-design/web-vue@latest/dist/arco-vue-icon.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@arco-design/web-vue@latest/dist/arco.css">
    <style>
        body { background-color: #f2f3f5; }
    </style>
</head>
<body>
    <div id="app">
        <a-layout style="min-height: 100vh;">
            <a-page-header
                style="background: #fff; border-bottom: 1px solid #e5e6eb;"
                title="JSON 配置编辑器"
                subtitle="可视化修改 Veplayer_live_list_m3u8.json"
                @back="goBack"
            >
                <template #extra>
                    <a-space>
                        <a-upload :show-file-list="false" :auto-upload="false" @change="handleImport">
                            <template #upload-button>
                                <a-button>
                                    <template #icon><icon-import /></template> 导入 JSON
                                </a-button>
                            </template>
                        </a-upload>
                        <a-button type="primary" status="success" @click="handleConfirmSave">
                            <template #icon><icon-save /></template> 确认修改并保存
                        </a-button>
                    </a-space>
                </template>
            </a-page-header>
            <a-layout-content style="padding: 24px;">
                <a-card :bordered="false" style="min-height: 600px;">
                    <a-tabs v-model:active-key="activeTab">
                        <template #extra>
                            <a-button type="primary" size="small" @click="handleAdd">
                                <template #icon><icon-plus /></template> 新增条目
                            </a-button>
                        </template>
                        <a-tab-pane v-for="key in ['profile', 'dashboard', 'settings']" :key="key" :title="getTabTitle(key)">
                            <a-table
                                :data="data[key]"
                                :columns="columns"
                                :pagination="false"
                                :scroll="{ x: 800 }"
                            >
                                <template #action="{ record, rowIndex }">
                                    <a-space>
                                        <a-button size="small" type="text" @click="handleEdit(rowIndex, record)">
                                            <template #icon><icon-edit /></template> 编辑
                                        </a-button>
                                        <a-button size="small" type="text" status="danger" @click="handleDelete(rowIndex)">
                                            <template #icon><icon-delete /></template> 删除
                                        </a-button>
                                    </a-space>
                                </template>
                            </a-table>
                        </a-tab-pane>
                    </a-tabs>
                </a-card>

                <a-modal
                    :visible="visible"
                    :title="editingItem ? '编辑条目' : '新增条目'"
                    @ok="handleSave"
                    @cancel="visible = false"
                >
                    <a-form :model="form" layout="vertical" ref="formRef">
                        <a-form-item label="名称 (Name)" field="name" :rules="[{ required: true, message: '请输入名称' }]">
                            <a-input v-model="form.name" placeholder="请输入显示名称" />
                        </a-form-item>
                        <a-form-item label="资源地址 (Add)" field="add" :rules="[{ required: true, message: '请输入地址' }]">
                            <a-input v-model="form.add" placeholder="输入 m3u8 / YouTube embed / Bilibili URL" />
                        </a-form-item>
                        <a-form-item label="缩略图 (PNG)" field="png">
                            <a-input v-model="form.png" placeholder="图片 URL" />
                        </a-form-item>
                        <a-form-item label="类型 (Type)" field="type">
                            <a-select v-model="form.type" :options="['直播', '视频']" placeholder="选择类型" />
                        </a-form-item>
                    </a-form>
                </a-modal>
            </a-layout-content>
        </a-layout>
    </div>

    <script>
        const { createApp } = Vue;
        const { Message, Modal } = ArcoVue;

        const App = {
            data() {
                return {
                    data: {
                        profile: [],
                        dashboard: [],
                        settings: []
                    },
                    activeTab: 'profile',
                    visible: false,
                    editingItem: null,
                    form: {
                        name: '',
                        add: '',
                        png: '',
                        type: ''
                    },
                    columns: [
                        {
                            title: '名称 (Name)',
                            dataIndex: 'name',
                            width: 200,
                        },
                        {
                            title: '地址 (Add/URL)',
                            dataIndex: 'add',
                            ellipsis: true,
                            tooltip: true
                        },
                        {
                            title: '类型 (Type)',
                            dataIndex: 'type',
                            width: 100,
                        },
                        {
                            title: '操作',
                            width: 160,
                            slotName: 'action'
                        },
                    ]
                };
            },
            mounted() {
                fetch(`Veplayer_live_list_m3u8.json?t=${new Date().getTime()}`)
                    .then(res => res.json())
                    .then(json => this.data = json)
                    .catch(() => {
                        Message.info('未检测到本地配置，请先导入或新建');
                    });
            },
            methods: {
                goBack() {
                    window.location.href = 'index.html';
                },
                getTabTitle(key) {
                    const map = {
                        profile: '央视直播 (Profile)',
                        dashboard: 'YouTube (Dashboard)',
                        settings: 'Bilibili (Settings)'
                    };
                    return map[key] || key;
                },
                handleImport(fileList) {
                    const file = fileList[fileList.length - 1].file;
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const json = JSON.parse(e.target.result);
                            this.data = json;
                            Message.success('导入成功');
                        } catch (err) {
                            Message.error('JSON 格式错误');
                        }
                    };
                    reader.readAsText(file);
                },
                async handleSaveFile() {
                    const jsonStr = JSON.stringify(this.data, null, 2);
                    
                    // Try File System Access API first
                    if (window.showSaveFilePicker) {
                        try {
                            const opts = {
                                suggestedName: 'Veplayer_live_list_m3u8.json',
                                types: [{
                                    description: 'JSON File',
                                    accept: { 'application/json': ['.json'] },
                                }],
                            };
                            const handle = await window.showSaveFilePicker(opts);
                            const writable = await handle.createWritable();
                            await writable.write(jsonStr);
                            await writable.close();
                            Message.success('文件已保存成功！');
                            return;
                        } catch (err) {
                            if (err.name === 'AbortError') return;
                            console.error(err);
                            // Fallback to download if error
                        }
                    }

                    // Fallback to legacy download
                    const blob = new Blob([jsonStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'Veplayer_live_list_m3u8.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    Modal.info({
                        title: '保存提示',
                        content: '由于浏览器安全限制，文件已作为下载项保存。请务必使用下载的文件替换项目根目录下的 "Veplayer_live_list_m3u8.json" 文件，否则修改不会生效。'
                    });
                },
                handleConfirmSave() {
                    Modal.confirm({
                        title: '确认保存修改？',
                        content: '这将生成新的配置文件。请确认是否继续？',
                        onOk: this.handleSaveFile,
                        okText: '确认保存',
                        cancelText: '取消'
                    });
                },
                handleEdit(index, item) {
                    this.editingItem = { ...item, _index: index };
                    this.form = { ...item };
                    this.visible = true;
                },
                handleAdd() {
                    this.editingItem = null;
                    this.form = { name: '', add: '', png: '', type: '' };
                    this.visible = true;
                },
                handleDelete(index) {
                    const list = [...this.data[this.activeTab]];
                    list.splice(index, 1);
                    this.data[this.activeTab] = list;
                    Message.success('已删除');
                },
                handleSave() {
                    this.$refs.formRef.validate((errors) => {
                        if (errors) return;

                        const list = [...this.data[this.activeTab]];
                        if (this.editingItem && this.editingItem._index !== undefined) {
                            list[this.editingItem._index] = { ...this.form };
                        } else {
                            list.push({ ...this.form });
                        }
                        
                        this.data[this.activeTab] = list;
                        this.visible = false;
                        Message.success('保存成功，请记得点击“确认修改并保存”');
                    });
                }
            }
        };

        const app = createApp(App);
        app.use(ArcoVue);
        app.use(ArcoVueIcon);
        app.mount('#app');
    </script>
</body>
</html>
