<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoH DNS 查询工具 - VisionKit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@arco-design/web-vue@latest/dist/arco-vue.min.js"></script>
    <script src="https://unpkg.com/@arco-design/web-vue@latest/dist/arco-vue-icon.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@arco-design/web-vue@latest/dist/arco.css">
    <style>
        body { background-color: #f2f3f5; }
        .result-card {
            transition: all 0.3s;
        }
        pre {
            background: #f7f8fa;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 13px;
            font-family: monospace;
        }
        
        /* 移动端适配 */
        @media screen and (max-width: 768px) {
            .arco-layout-content {
                padding: 16px !important;
            }
            
            /* PageHeader 移动端终极适配 */
            .arco-page-header {
                padding: 12px 16px !important;
            }
            
            /* 强制 main 容器变为 flex 且换行 */
            .arco-page-header-header .arco-page-header-main {
                display: flex !important;
                flex-wrap: wrap !important;
                align-items: center !important;
                width: 100% !important;
            }
            
            /* 返回按钮：防压缩，定间距 */
            .arco-page-header-back-btn {
                margin-right: 8px !important;
                flex-shrink: 0 !important;
                display: inline-flex !important;
                color: var(--color-text-1);
            }
            
            /* 标题：占满剩余空间，单行省略 */
            .arco-page-header-title {
                flex: 1 1 auto !important;
                width: 0 !important;
                min-width: 0 !important;
                margin-right: 0 !important;
                margin-bottom: 0 !important;
                font-size: 16px !important;
                font-weight: 500;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }
            
            /* 隐藏分割线 */
            .arco-page-header-divider {
                display: none !important;
            }
            
            /* 副标题：独占一行，自动换行 */
            .arco-page-header-subtitle {
                display: block !important;
                width: 100% !important;
                margin-left: 0 !important;
                margin-top: 6px !important;
                font-size: 13px !important;
                color: var(--color-text-3);
                line-height: 1.5 !important;
                white-space: normal !important;
            }
            
            /* 移除 wrapper 可能的干扰 */
            .arco-page-header-wrapper {
                padding-left: 0 !important;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <a-layout style="min-height: 100vh;">
            <a-page-header
                style="background: #fff; border-bottom: 1px solid #e5e6eb;"
                title="DNS over HTTPS 工具"
                subtitle="安全、快速的域名解析查询"
                @back="goBack"
            ></a-page-header>
            <a-layout-content class="arco-layout-content" style="padding: 24px;">
                <div style="max-width: 1000px; margin: 0 auto;">
                    <a-card :bordered="false" style="margin-bottom: 24px;">
                        <a-form
                            :model="form"
                            layout="vertical"
                            @submit="handleSearch"
                        >
                            <a-row :gutter="24">
                                <a-col :xs="24" :sm="24" :md="8">
                                    <a-form-item label="DoH 服务商" field="provider" :rules="[{ required: true }]">
                                        <a-select v-model="form.provider">
                                            <a-option v-for="(p, key) in providers" :key="key" :value="key">
                                                {{ p.name }}
                                            </a-option>
                                        </a-select>
                                    </a-form-item>
                                </a-col>
                                <a-col :xs="24" :sm="24" :md="10">
                                    <a-form-item label="域名 (Domain)" field="domain" :rules="[{ required: true, message: '请输入域名' }]">
                                        <a-input v-model="form.domain" placeholder="example.com" allow-clear />
                                    </a-form-item>
                                </a-col>
                                <a-col :xs="16" :sm="16" :md="6">
                                    <a-form-item label="记录类型" field="type" :rules="[{ required: true }]">
                                        <a-select v-model="form.type">
                                            <a-option v-for="t in recordTypes" :key="t" :value="t">{{ t }}</a-option>
                                        </a-select>
                                    </a-form-item>
                                </a-col>
                            </a-row>
                            <a-form-item style="margin-bottom: 0;">
                                <a-button type="primary" html-type="submit" long :loading="loading">
                                    <template #icon><icon-search /></template>
                                    立即查询
                                </a-button>
                            </a-form-item>
                        </a-form>
                    </a-card>

                    <div v-if="loading" style="text-align: center; padding: 40px;">
                        <a-spin tip="正在向 DoH 服务器查询..." />
                    </div>

                    <div v-if="result">
                        <a-space direction="vertical" size="large" style="width: 100%;">
                            <a-card title="查询结果" :bordered="false">
                                <a-descriptions
                                    :column="1"
                                    :data="[
                                        { label: '状态', value: rcodeMap[result.Status] || result.Status, isTag: true },
                                        { label: '响应时间', value: new Date().toLocaleTimeString() },
                                        { label: 'TC (Truncated)', value: result.TC ? '是' : '否' },
                                        { label: 'RD (Recursion Desired)', value: result.RD ? '是' : '否' },
                                        { label: 'RA (Recursion Available)', value: result.RA ? '是' : '否' },
                                    ]"
                                    style="margin-bottom: 24px;"
                                    :label-style="{ width: '140px' }"
                                >
                                    <template #value="{ data }">
                                        <a-tag v-if="data.isTag" :color="result.Status === 0 ? 'green' : 'red'">
                                            {{ data.value }}
                                        </a-tag>
                                        <span v-else>{{ data.value }}</span>
                                    </template>
                                </a-descriptions>
                                
                                <a-typography-title :heading="6">Answer Records</a-typography-title>
                                <template v-if="result.Answer && result.Answer.length > 0">
                                    <a-table
                                        :columns="columns"
                                        :data="result.Answer"
                                        :pagination="false"
                                        :scroll="{ x: 600 }"
                                    >
                                        <template #name="{ record }">
                                            <span style="word-break: break-all;">{{ record.name }}</span>
                                        </template>
                                        <template #type="{ record }">
                                            <a-tag color="arcoblue">{{ typeMap[record.type] || record.type }}</a-tag>
                                        </template>
                                        <template #data="{ record }">
                                            <span style="word-break: break-all; font-family: monospace;">{{ record.data }}</span>
                                        </template>
                                    </a-table>
                                </template>
                                <a-empty v-else description="未找到记录 (No Answer)" />
                            </a-card>

                            <a-card title="原始 JSON 响应" :bordered="false">
                                <pre>{{ JSON.stringify(rawJson, null, 2) }}</pre>
                            </a-card>
                        </a-space>
                    </div>
                </div>
            </a-layout-content>
        </a-layout>
    </div>

    <script>
        const { createApp } = Vue;
        const { Message } = ArcoVue;

        const App = {
            data() {
                return {
                    form: {
                        provider: 'cloudflare',
                        domain: '',
                        type: 'A'
                    },
                    loading: false,
                    result: null,
                    rawJson: null,
                    providers: {
                        cloudflare: {
                            url: 'https://cloudflare-dns.com/dns-query',
                            name: 'Cloudflare (1.1.1.1)',
                            color: 'blue'
                        },
                        alidns: {
                            url: 'https://dns.alidns.com/resolve',
                            name: '阿里云 AliDNS',
                            color: 'orange'
                        },
                        tencent: {
                            url: 'https://doh.pub/dns-query',
                            name: '腾讯云 DNSPod',
                            color: 'green'
                        }
                    },
                    recordTypes: ['A', 'AAAA', 'CNAME', 'MX', 'TXT', 'NS', 'PTR', 'SOA', 'SRV'],
                    rcodeMap: {
                        0: 'NOERROR',
                        1: 'FORMERR',
                        2: 'SERVFAIL',
                        3: 'NXDOMAIN',
                        4: 'NOTIMP',
                        5: 'REFUSED'
                    },
                    typeMap: {
                        1: 'A',
                        2: 'NS',
                        5: 'CNAME',
                        6: 'SOA',
                        12: 'PTR',
                        15: 'MX',
                        16: 'TXT',
                        28: 'AAAA',
                        33: 'SRV'
                    },
                    columns: [
                        {
                            title: '记录名 (Name)',
                            dataIndex: 'name',
                            slotName: 'name'
                        },
                        {
                            title: '类型 (Type)',
                            dataIndex: 'type',
                            width: 100,
                            slotName: 'type'
                        },
                        {
                            title: 'TTL',
                            dataIndex: 'TTL',
                            width: 80,
                        },
                        {
                            title: '记录值 (Data)',
                            dataIndex: 'data',
                            slotName: 'data'
                        }
                    ]
                };
            },
            methods: {
                goBack() {
                    window.location.href = 'index.html';
                },
                async handleSearch({values, errors}) {
                    if (errors) return;
                    
                    try {
                        this.loading = true;
                        this.result = null;
                        this.rawJson = null;

                        const provider = this.providers[this.form.provider];
                        let url = new URL(provider.url);
                        url.searchParams.append('name', this.form.domain);
                        url.searchParams.append('type', this.form.type);

                        const headers = {
                            'Accept': 'application/dns-json'
                        };

                        const response = await fetch(url.toString(), { headers });
                        if (!response.ok) {
                            throw new Error(`HTTP Error: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        this.rawJson = data;
                        this.result = data;
                        
                        if (data.Status !== 0) {
                            Message.warning(`查询返回非正常状态: ${this.rcodeMap[data.Status] || data.Status}`);
                        } else {
                            Message.success('查询成功');
                        }
                    } catch (err) {
                        console.error(err);
                        Message.error(`查询失败: ${err.message}`);
                    } finally {
                        this.loading = false;
                    }
                }
            }
        };

        const app = createApp(App);
        app.use(ArcoVue);
        app.use(ArcoVueIcon);
        app.mount('#app');
    </script>
</body>
</html>
