<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>综合媒体导航 - VisionKit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@arco-design/web-vue@latest/dist/arco-vue.min.js"></script>
    <script src="https://unpkg.com/@arco-design/web-vue@latest/dist/arco-vue-icon.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@arco-design/web-vue@latest/dist/arco.css">
    <style>
        body { background-color: #f2f3f5; }
        .media-card-img {
            height: 100px;
            background-size: cover;
            background-position: center;
            background-color: #e5e6eb;
        }
        .player-container {
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 */
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .player-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .nav-list-container {
            height: calc(100vh - 120px);
            overflow-y: auto;
            padding-right: 4px;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #c9cdd4; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
        
        .list-item-active {
            background: #e8f3ff !important;
            border-radius: 4px;
        }
        .list-item-hover:hover {
            background: #f7f8fa !important;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="app">
        <a-layout :style="{ height: isMobile ? 'auto' : '100vh', minHeight: '100vh', overflow: isMobile ? 'auto' : 'hidden' }">
            <a-page-header
                style="background: #fff; border-bottom: 1px solid #e5e6eb; flex-shrink: 0; position: sticky; top: 0; z-index: 10;"
                title="综合媒体导航"
                :subtitle="isMobile ? null : '多平台资源聚合'"
                @back="goBack"
            >
                <template #extra>
                    <a-button v-if="isMobile" @click="visibleMenu = true">
                        <template #icon><icon-menu-unfold /></template>
                    </a-button>
                </template>
            </a-page-header>
            
            <!-- Mobile Drawer Menu -->
            <a-drawer
                v-if="isMobile"
                :visible="visibleMenu"
                @ok="visibleMenu = false"
                @cancel="visibleMenu = false"
                placement="left"
                :width="240"
                title="频道导航"
                :footer="false"
            >
                <a-menu
                    style="width: 100%; height: 100%;"
                    :selected-keys="[selectedKey]"
                    @menu-item-click="handleMenuClick"
                >
                    <a-menu-item key="cctv"><template #icon><icon-menu /></template>央视 (CCTV)</a-menu-item>
                    <a-menu-item key="youtube"><template #icon><icon-video-camera /></template>YouTube</a-menu-item>
                    <a-menu-item key="bilibili"><template #icon><icon-play-circle /></template>Bilibili</a-menu-item>
                    <a-menu-item key="live_youtube"><template #icon><icon-wifi /></template>Live YouTube</a-menu-item>
                </a-menu>
            </a-drawer>

            <a-layout :style="{ flex: 1, overflow: 'hidden', flexDirection: isMobile ? 'column' : 'row' }">
                <a-layout-sider v-if="!isMobile" style="background: #fff; border-right: 1px solid #e5e6eb;" :width="200">
                    <a-menu
                        style="width: 100%; height: 100%;"
                        :selected-keys="[selectedKey]"
                        @menu-item-click="handleMenuClick"
                    >
                        <a-menu-item key="cctv"><template #icon><icon-menu /></template>央视 (CCTV)</a-menu-item>
                        <a-menu-item key="youtube"><template #icon><icon-video-camera /></template>YouTube</a-menu-item>
                        <a-menu-item key="bilibili"><template #icon><icon-play-circle /></template>Bilibili</a-menu-item>
                        <a-menu-item key="live_youtube"><template #icon><icon-wifi /></template>Live YouTube</a-menu-item>
                    </a-menu>
                </a-layout-sider>
                
                <a-layout-content :style="{ padding: isMobile ? '12px' : '24px', overflow: isMobile ? 'visible' : 'hidden', background: '#f7f8fa' }">
                    <a-row :gutter="[24, 24]" :style="{ height: isMobile ? 'auto' : '100%' }">
                        <a-col :xs="24" :md="17" :style="{ height: isMobile ? 'auto' : '100%', overflowY: isMobile ? 'visible' : 'auto', marginBottom: isMobile ? '16px' : 0 }">
                            <div :style="{ background: '#fff', padding: isMobile ? '12px' : '24px', borderRadius: '8px', minHeight: isMobile ? 'auto' : '100%', display: 'flex', flexDirection: 'column' }">
                                <a-typography-title :heading="5" style="margin-top: 0; margin-bottom: 16px;">
                                    {{ currentMedia?.title || '未选择视频' }}
                                </a-typography-title>
                                <div :style="{ flex: isMobile ? 'none' : 1 }">
                                    <div v-if="!currentMedia" class="player-container" style="display: flex; align-items: center; justify-content: center; color: #fff;">
                                        <div style="text-align: center;">
                                            <icon-video-camera style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;" />
                                            <div>请选择左侧菜单或右侧列表播放视频</div>
                                        </div>
                                    </div>
                                    <div v-else class="player-container">
                                        <iframe 
                                            :src="getPlayerSrc()" 
                                            frameBorder="0" 
                                            allowFullScreen 
                                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                        ></iframe>
                                    </div>
                                </div>
                            </div>
                        </a-col>
                        <a-col :xs="24" :md="7" :style="{ height: isMobile ? 'auto' : '100%' }">
                            <div :style="{ background: '#fff', borderRadius: '8px', height: isMobile ? '500px' : '100%', display: 'flex', flexDirection: 'column' }">
                                <div style="padding: 16px 20px; border-bottom: 1px solid #f2f3f5;">
                                    <a-typography-title :heading="6" style="margin: 0;">播放列表</a-typography-title>
                                </div>
                                
                                <div v-if="selectedKey === 'live_youtube'" style="padding: 16px;">
                                    <a-typography-title :heading="6">手动播放 YouTube</a-typography-title>
                                    <a-input-search
                                        search-button="播放"
                                        placeholder="输入 YouTube 视频 ID 或 URL"
                                        v-model="customYoutubeUrl"
                                        @search="handleCustomPlay"
                                        style="width: 100%; margin-bottom: 16px;"
                                    />
                                    <div style="color: #86909c; font-size: 12px;">
                                        支持格式：
                                        <br/>- 视频 ID: dQw4w9WgXcQ
                                        <br/>- 完整 URL: https://www.youtube.com/watch?v=...
                                    </div>
                                </div><div v-else-if="loading" style="padding: 20px; text-align: center;"><a-spin /></div><div v-else-if="error && items.length === 0" style="padding: 16px;">
                                    <a-alert type="warning" :content="error" />
                                </div><a-empty v-else-if="items.length === 0" description="暂无内容"></a-empty><div v-else class="nav-list-container">
                                    <div 
                                        v-for="(item, index) in items" 
                                        :key="item.id || index"
                                        class="list-item-hover"
                                        :style="{ 
                                            cursor: 'pointer', 
                                            background: currentMedia?.id === item.id ? '#e8f3ff' : 'transparent',
                                            transition: 'all 0.2s',
                                            borderBottom: '1px solid #f2f3f5',
                                            padding: '12px',
                                            display: 'flex',
                                            alignItems: 'flex-start'
                                        }"
                                        @click="handlePlay(item)"
                                    >
                                        <!-- Avatar -->
                                        <div 
                                            :style="{ 
                                                width: '120px', 
                                                height: '68px', 
                                                backgroundImage: `url(${item.thumbnail})`,
                                                backgroundSize: 'cover',
                                                backgroundPosition: 'center',
                                                borderRadius: '4px',
                                                backgroundColor: '#ffffff',
                                                position: 'relative',
                                                border: '1px solid #e5e6eb',
                                                flexShrink: 0,
                                                marginRight: '12px'
                                            }" 
                                        >
                                            <div v-if="currentMedia?.id === item.id" style="
                                                position: absolute;
                                                top: 0; left: 0; right: 0; bottom: 0;
                                                background: rgba(22,93,255,0.6);
                                                display: flex;
                                                align-items: center;
                                                justify-content: center;
                                                border-radius: 4px;
                                            ">
                                                <icon-play-circle style="color: #fff; font-size: 24px;" />
                                            </div>
                                        </div>

                                        <!-- Info -->
                                        <div style="flex: 1; min-width: 0;">
                                            <div 
                                                style="margin-bottom: 8px; font-size: 14px; line-height: 1.4;"
                                                :style="{ 
                                                    fontWeight: currentMedia?.id === item.id ? 'bold' : 'normal',
                                                    color: currentMedia?.id === item.id ? '#165dff' : '#1d2129'
                                                }"
                                            >
                                                {{ item.title }}
                                            </div>
                                            <a-space :size="4">
                                                <a-tag size="small" color="arcoblue">
                                                    {{ item.type === 'stream' ? 'CCTV' : item.type.toUpperCase() }}
                                                </a-tag>
                                                <a-tag v-if="item.tagType" :color="item.tagType === '直播' ? 'red' : 'green'" size="small">
                                                    {{ item.tagType }}
                                                </a-tag>
                                            </a-space>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a-col>
                    </a-row>
                </a-layout-content>
            </a-layout>
        </a-layout>
    </div>

    <script>
        const { createApp, ref, reactive, computed, watch, onMounted, onBeforeUnmount } = Vue;
        const { Message } = ArcoVue;

        const App = {
            setup() {
                // ==========================================
                // 状态定义 (State Definitions)
                // ==========================================
                
                // 当前选中的菜单项 Key (默认为央视)
                const selectedKey = ref('cctv');
                
                // 当前播放的媒体对象
                const currentMedia = ref(null);
                
                // 移动端菜单显示状态
                const visibleMenu = ref(false);
                
                // 是否为移动端视图
                const isMobile = ref(window.innerWidth < 768);
                
                // 媒体数据源
                const mediaData = reactive({
                    cctv: [],
                    youtube: [],
                    bilibili: [],
                    live_youtube: []
                });
                
                // 加载状态
                const loading = ref(true);
                
                // 错误信息
                const error = ref(null);
                
                // 自定义 YouTube 播放 URL
                const customYoutubeUrl = ref('');

                // ==========================================
                // 计算属性 (Computed Properties)
                // ==========================================
                
                // 根据选中 Key 获取当前列表项
                const items = computed(() => {
                    return mediaData[selectedKey.value] || [];
                });

                // ==========================================
                // 监听器 (Watchers)
                // ==========================================
                
                // 监听分类切换，自动播放列表第一项
                watch(selectedKey, (newKey) => {
                    // Live YouTube 模式不自动播放
                    if (newKey === 'live_youtube') {
                        currentMedia.value = null;
                        return;
                    }
                    
                    const list = mediaData[newKey] || [];
                    if (list.length > 0) {
                        currentMedia.value = list[0];
                    } else {
                        currentMedia.value = null;
                    }
                });

                // ==========================================
                // 方法 (Methods)
                // ==========================================

                // 处理窗口大小变化
                const handleResize = () => {
                    isMobile.value = window.innerWidth < 768;
                };

                // 返回主页
                const goBack = () => {
                    window.location.href = 'index.html';
                };

                // 处理菜单点击
                const handleMenuClick = (key) => {
                    selectedKey.value = key;
                    visibleMenu.value = false;
                };

                // 保留：无手动导入，使用自动加载

                // 处理媒体解析逻辑
                const processData = (json) => {
                    try {
                        // 解析 CCTV 数据
                        const cctvData = (json.profile || []).map((item, idx) => ({
                            id: `cctv-${idx}`,
                            title: item.name,
                            type: 'stream',
                            tagType: item.type,
                            streamUrl: item.add,
                            thumbnail: item.png
                        }));

                        // 解析 YouTube 数据
                        const youtubeData = (json.dashboard || []).map((item, idx) => {
                            const idMatch = item.add.match(/embed\/([^?]+)/);
                            return {
                                id: idMatch ? idMatch[1] : `yt-${idx}`,
                                title: item.name,
                                type: 'youtube',
                                tagType: item.type,
                                thumbnail: item.png
                            };
                        });

                        // 解析 Bilibili 数据
                        const bilibiliData = (json.settings || []).map((item, idx) => ({
                            id: `bili-${idx}`,
                            title: item.name,
                            type: 'bilibili',
                            tagType: item.type,
                            url: item.add,
                            thumbnail: item.png
                        }));

                        // 更新响应式数据
                        mediaData.cctv = cctvData;
                        mediaData.youtube = youtubeData;
                        mediaData.bilibili = bilibiliData;
                        mediaData.live_youtube = [];

                        // 数据加载完成后，初始化播放选中分类的第一项
                        if (selectedKey.value && mediaData[selectedKey.value] && mediaData[selectedKey.value].length > 0) {
                            currentMedia.value = mediaData[selectedKey.value][0];
                        }
                    } catch (e) {
                        console.error("Data processing error:", e);
                        Message.error("数据解析异常");
                    }
                };

                // 获取数据
                const fetchData = async () => {
                    loading.value = true;
                    error.value = null;
                    try {
                        if (window.location.protocol === 'file:') {
                            throw new Error('当前为本地文件模式，浏览器阻止读取 JSON，请使用本地 HTTP 服务');
                        }
                        const controller = new AbortController();
                        const timeout = setTimeout(() => controller.abort(), 12000);
                        const response = await fetch(`Veplayer_live_list_m3u8.json?t=${Date.now()}`, { signal: controller.signal, cache: 'no-store' });
                        clearTimeout(timeout);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status} 读取失败`);
                        }
                        const json = await response.json();
                        processData(json);
                    } catch (err) {
                        if (err.name === 'AbortError') {
                            error.value = '请求超时，请重试或检查网络';
                        } else if (typeof err.message === 'string' && err.message.startsWith('HTTP')) {
                            error.value = '文件未找到或读取失败，请确认路径与服务器';
                        } else if (err instanceof SyntaxError) {
                            error.value = 'JSON 格式错误，无法解析';
                        } else {
                            error.value = err.message || '网络错误或跨域限制';
                        }
                    } finally {
                        loading.value = false;
                    }
                };

                // 保留：刷新逻辑移除，使用首次加载

                // 处理列表项点击播放
                const handlePlay = (item) => {
                    currentMedia.value = item;
                };

                // 处理自定义 YouTube 播放
                const handleCustomPlay = () => {
                    if (!customYoutubeUrl.value) {
                        Message.warning('请输入 YouTube 视频 ID 或 URL');
                        return;
                    }
                    
                    let id = customYoutubeUrl.value;
                    // 正则提取 Video ID
                    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                    const match = customYoutubeUrl.value.match(regExp);
                    if (match && match[2].length === 11) {
                        id = match[2];
                    }

                    currentMedia.value = {
                        id: id,
                        title: 'Live YouTube 播放',
                        type: 'youtube'
                    };
                };

                // 保留：移除手动文件上传功能

                // 获取 iframe src
                const getPlayerSrc = () => {
                    if (!currentMedia.value) return '';
                    if (currentMedia.value.type === 'youtube') {
                        return `https://www.youtube.com/embed/${currentMedia.value.id}?autoplay=1`;
                    } else if (currentMedia.value.type === 'bilibili') {
                        return currentMedia.value.url;
                    } else if (currentMedia.value.type === 'stream') {
                        return `ve_no_controls.html?src=${encodeURIComponent(currentMedia.value.streamUrl)}&autoplay=1`;
                    }
                    return '';
                };

                // ==========================================
                // 生命周期 (Lifecycle Hooks)
                // ==========================================
                
                onMounted(() => {
                    window.addEventListener('resize', handleResize);
                    fetchData();
                });

                onBeforeUnmount(() => {
                    window.removeEventListener('resize', handleResize);
                });

                // 返回给模板的数据和方法
                return {
                    selectedKey,
                    currentMedia,
                    visibleMenu,
                    isMobile,
                    mediaData,
                    loading,
                    error,
                    customYoutubeUrl,
                    items,
                    handleResize,
                    goBack,
                    handleMenuClick,
                    fetchData,
                    processData,
                    handlePlay,
                    handleCustomPlay,
                    getPlayerSrc
                };
            }
        };

        const app = createApp(App);
        app.use(ArcoVue);
        app.use(ArcoVueIcon);
        app.mount('#app');
    </script>
</body>
</html>
